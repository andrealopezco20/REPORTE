<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reporte Musical Avanzado</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #6a5acd;
      --secondary-color: #9370db;
      --accent-color: #ff7f50;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --success-color: #28a745;
      --info-color: #17a2b8;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --text-color: #333;
      --text-light: #666;
      --bg-color: #f5f5f5;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.1);
    }
    
    header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 25px;
      border-bottom: 1px solid #eee;
    }
    
    h1 {
      color: var(--primary-color);
      font-family: 'Montserrat', sans-serif;
      font-size: 2.8rem;
      margin-bottom: 15px;
      font-weight: 700;
    }
    
    .date-range {
      color: var(--text-light);
      font-size: 1.2rem;
      margin-bottom: 25px;
      font-weight: 300;
    }
    
    .section {
      margin-bottom: 50px;
      padding: 25px;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
    }
    
    .section-title {
      color: var(--primary-color);
      font-family: 'Montserrat', sans-serif;
      font-size: 1.8rem;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--secondary-color);
      font-weight: 600;
    }
    
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin-bottom: 35px;
    }
    
    .chart-container {
      position: relative;
      height: 380px;
      background-color: white;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      margin: 8px;
      overflow: hidden;
    }
    
    canvas {
      display: block;
      width: 100% !important;
      height: 100% !important;
      max-width: 100%;
      max-height: 100%;
    }
    
    .chart-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .chart-title {
      font-family: 'Montserrat', sans-serif;
      font-size: 1.1rem;
      color: var(--primary-color);
      margin-bottom: 12px;
      text-align: center;
      font-weight: 600;
    }
    
    select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: white;
      font-size: 1rem;
      margin-bottom: 20px;
      width: 100%;
      max-width: 350px;
      font-family: 'Roboto', sans-serif;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    
    select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(106, 90, 205, 0.2);
    }
    
    .table-container {
      overflow-x: auto;
      margin-bottom: 25px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.5px;
    }
    
    tr:nth-child(even) {
      background-color: #fafafa;
    }
    
    tr:hover {
      background-color: #f1f1f1;
    }
    
    .progress-container {
      margin-bottom: 20px;
    }
    
    .progress-title {
      margin-bottom: 10px;
      font-weight: 500;
      color: var(--text-color);
      font-size: 0.9rem;
    }
    
    .progress-bar {
      height: 18px;
      background-color: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .progress {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      border-radius: 10px;
      transition: width 0.6s ease;
      position: relative;
    }
    
    .progress::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        to right,
        rgba(255, 255, 255, 0.1) 0%,
        rgba(255, 255, 255, 0.3) 50%,
        rgba(255, 255, 255, 0.1) 100%
      );
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
      border-radius: 10px;
    }
    
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .song-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .song-card {
      background-color: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    
    .song-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .song-title {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--dark-color);
      font-size: 1rem;
    }
    
    .song-artist {
      color: var(--text-light);
      font-size: 0.85rem;
      margin-bottom: 12px;
    }
    
    .song-stats {
      margin-top: auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .song-count {
      background-color: var(--primary-color);
      color: white;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .song-emoji {
      font-size: 1rem;
    }
    
    .day-highlight {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      border-left: 5px solid var(--primary-color);
    }
    
    .day-title {
      font-size: 1.4rem;
      color: var(--primary-color);
      margin-bottom: 12px;
      font-weight: 600;
    }
    
    .day-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .stat-card {
      flex: 1;
      min-width: 180px;
      background-color: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
    }
    
    .stat-title {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    @media (max-width: 1200px) {
      .container {
        padding: 25px;
      }
      
      .grid-container {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .grid-container {
        grid-template-columns: 1fr;
      }
      
      .song-list {
        grid-template-columns: 1fr 1fr;
      }
      
      h1 {
        font-size: 2.2rem;
      }
      
      .section-title {
        font-size: 1.5rem;
      }
      
      .chart-container {
        height: 320px;
        padding: 10px;
      }
    }
    
    @media (max-width: 480px) {
      .song-list {
        grid-template-columns: 1fr;
      }
      
      .container {
        padding: 20px;
      }
      
      .section {
        padding: 20px;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .chart-container {
        height: 280px;
        padding: 8px;
      }
      
      .section-title {
        font-size: 1.3rem;
        margin-bottom: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä Reporte Musical</h1>
      <div class="date-range" id="dateRange">Cargando datos...</div>
    </header>
    
    <div class="section">
      <h2 class="section-title">Resumen General</h2>
      <div class="grid-container">
        <div class="chart-container">
          <div class="chart-title">Top 10 Canciones</div>
          <canvas id="cancionesChart"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title">Distribuci√≥n de Emociones</div>
          <canvas id="emocionGeneralChart"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title">Actividades m√°s Comunes</div>
          <canvas id="actividadGeneralChart"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title">Uso de Plataformas</div>
          <canvas id="plataformaGeneralChart"></canvas>
        </div>
      </div>
    </div>
    
    <div class="section">
      <h2 class="section-title">An√°lisis por D√≠a</h2>
      <label for="daySelect">Selecciona un d√≠a:</label>
      <select id="daySelect"></select>
      
      <div id="dayHighlight" class="day-highlight">
        <div class="day-title" id="selectedDayTitle">Selecciona un d√≠a para ver detalles</div>
        <div class="day-stats">
          <div class="stat-card">
            <div class="stat-title">Total Canciones</div>
            <div class="stat-value" id="totalSongs">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Emoci√≥n Principal</div>
            <div class="stat-value" id="mainEmotion">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Lugar Principal</div>
            <div class="stat-value" id="mainPlace">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Plataforma Principal</div>
            <div class="stat-value" id="mainPlatform">-</div>
          </div>
        </div>
      </div>
      
      <div class="grid-container">
        <div class="chart-container">
          <div class="chart-title">Lugares de Escucha</div>
          <canvas id="lugarChart"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title">Plataformas Usadas</div>
          <canvas id="plataformaChart"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title">Distribuci√≥n de Emociones</div>
          <canvas id="emocionChart"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title">Actividades Realizadas</div>
          <canvas id="actividadChart"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title">Dispositivos Usados</div>
          <canvas id="dispositivoChart"></canvas>
        </div>
        <div class="chart-container">
          <div class="chart-title">Emociones por Hora</div>
          <canvas id="horaEmocionChart"></canvas>
        </div>
      </div>
    </div>
    
    <div class="section">
      <h2 class="section-title">Canciones m√°s Escuchadas</h2>
      <div class="song-list" id="topSongsList"></div>
    </div>
    
    <div class="section">
      <h2 class="section-title">Actividad Reciente</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Canci√≥n</th>
              <th>Artista</th>
              <th>Emoci√≥n</th>
              <th>Actividad</th>
            </tr>
          </thead>
          <tbody id="recentActivity">
            <!-- Datos se llenar√°n con JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // URL de tu Google Sheet en formato CSV
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRSfbioyCi39WhPj6Y45oisw4Vx0aqHdIv2FcV2cQqbWziho1yJKRz48Ij3WDQsOGcpdJz6MQIH2i2Q/pub?gid=0&single=true&output=csv";

    let allData = [];
    let charts = {};

    // Colores personalizados para los gr√°ficos
    const chartColors = [
      '#6a5acd', '#9370db', '#ff7f50', '#ffa07a', '#20b2aa', 
      '#32cd32', '#daa520', '#4169e1', '#8a2be2', '#ff6347',
      '#4682b4', '#9acd32', '#40e0d0', '#ff69b4', '#ba55d3'
    ];

    // Emojis para emociones
    const emotionEmojis = {
      'Energ√©tica': '‚ö°',
      'Alegre': 'üòä',
      'Divertida': 'üòÇ',
      'Animada': 'üéâ',
      'Motivacional': 'üí™',
      'Nost√°lgica': 'üï∞Ô∏è',
      'Rom√°ntica': '‚ù§Ô∏è',
      'Empoderada': 'üëë',
      'Emocional': 'ü•≤',
      'Relajada': 'üòå'
    };

    // Funci√≥n para formatear fechas
    function formatDate(dateStr) {
      if (!dateStr) return 'Fecha desconocida';
      // Asume formato DD/MM/AAAA y lo normaliza
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        return `${parts[0].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${parts[2]}`;
      }
      return dateStr;
    }

    // Mostrar mensaje de error
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.style.background = '#ffebee';
      errorDiv.style.color = '#c62828';
      errorDiv.style.padding = '15px';
      errorDiv.style.margin = '15px 0';
      errorDiv.style.borderRadius = '4px';
      errorDiv.style.border = '1px solid #ef9a9a';
      errorDiv.innerHTML = `
        <strong>Error:</strong> ${message}<br>
        <small>URL utilizada: ${csvUrl}</small>
      `;
      document.querySelector('.container').prepend(errorDiv);
    }

    // Cargar datos desde Google Sheets
    function loadData() {
      // Mostrar estado de carga
      document.getElementById('dateRange').textContent = "Cargando datos...";
      
      // Usar proxy CORS para evitar problemas
      const proxyUrl = 'https://api.allorigins.win/raw?url=';
      const encodedUrl = encodeURIComponent(csvUrl);
      
      fetch(proxyUrl + encodedUrl)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.text();
        })
        .then(csvData => {
          Papa.parse(csvData, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
              console.log("Datos cargados:", results);
              
              if (results.errors.length > 0) {
                console.warn("Errores de parseo:", results.errors);
              }
              
              // Validar estructura b√°sica de datos
              if (!results.data || results.data.length === 0 || !results.data[0].D√≠a) {
                showError("La estructura del archivo no coincide con lo esperado. Verifica los encabezados.");
                return;
              }
              
              // Procesar y limpiar datos
              allData = results.data.map(row => ({
                D√≠a: formatDate(row.D√≠a),
                Canci√≥n: row.Canci√≥n?.trim() || 'Desconocido',
                Artista: row.Artista?.trim() || 'Desconocido',
                Emoci√≥n: row.Emoci√≥n?.trim() || 'Sin especificar',
                Lugar: row.Lugar?.trim() || 'Sin especificar',
                Actividad: row.Actividad?.trim() || 'Sin especificar',
                Plataforma: row.Plataforma?.trim() || 'Sin especificar',
                'Dispositivo usado': row['Dispositivo usado']?.trim() || 'Sin especificar'
              }));
              
              initializeVisualizations();
            },
            error: function(error) {
              console.error("Error al parsear CSV:", error);
              showError(`Error al procesar los datos: ${error.message}`);
            }
          });
        })
        .catch(error => {
          console.error("Error al cargar datos:", error);
          showError(`Error al cargar datos: ${error.message}. Prueba recargando la p√°gina.`);
        });
    }

    // Actualizar el rango de fechas en el encabezado
    function updateDateRange() {
      if (!allData || allData.length === 0) return;
      
      const dates = [...new Set(allData.map(row => row.D√≠a))].sort();
      const startDate = dates[0];
      const endDate = dates[dates.length - 1];
      
      document.getElementById('dateRange').textContent = `${startDate} - ${endDate}`;
    }

    // Inicializar todas las visualizaciones
    function initializeVisualizations() {
      try {
        updateDateRange();
        generarGraficosIniciales();
        cargarDias();
        mostrarTopCanciones();
        mostrarActividadReciente();
        addRefreshButton();
      } catch (e) {
        console.error("Error al inicializar visualizaciones:", e);
        showError(`Error al procesar los datos: ${e.message}`);
      }
    }

    // A√±adir bot√≥n de actualizaci√≥n
    function addRefreshButton() {
      if (document.getElementById('refreshBtn')) return;
      
      const btn = document.createElement('button');
      btn.id = 'refreshBtn';
      btn.textContent = 'üîÑ Actualizar Datos';
      btn.style.position = 'fixed';
      btn.style.bottom = '20px';
      btn.style.right = '20px';
      btn.style.padding = '10px 15px';
      btn.style.background = 'var(--primary-color)';
      btn.style.color = 'white';
      btn.style.border = 'none';
      btn.style.borderRadius = '5px';
      btn.style.cursor = 'pointer';
      btn.style.zIndex = '1000';
      btn.onclick = loadData;
      document.body.appendChild(btn);
    }

    // Funci√≥n para generar los gr√°ficos iniciales
    function generarGraficosIniciales() {
      // Gr√°fico de canciones m√°s escuchadas
      const canciones = {};
      allData.forEach(row => {
        canciones[row.Canci√≥n] = (canciones[row.Canci√≥n] || 0) + 1;
      });
      
      // Ordenar canciones por frecuencia
      const cancionesOrdenadas = Object.entries(canciones)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      const ctxCanciones = document.getElementById('cancionesChart').getContext('2d');
      if (charts.cancionesChart) charts.cancionesChart.destroy();
      charts.cancionesChart = new Chart(ctxCanciones, {
        type: 'doughnut',
        data: {
          labels: cancionesOrdenadas.map(item => item[0]),
          datasets: [{
            data: cancionesOrdenadas.map(item => item[1]),
            backgroundColor: chartColors.slice(0, cancionesOrdenadas.length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                font: {
                  size: 11
                }
              }
            },
            title: {
              display: true,
              text: 'Top 10 Canciones',
              font: {
                size: 13
              }
            }
          }
        }
      });

      // Gr√°fico de emociones generales
      const emociones = {};
      allData.forEach(row => {
        emociones[row.Emoci√≥n] = (emociones[row.Emoci√≥n] || 0) + 1;
      });

      const ctxEmociones = document.getElementById('emocionGeneralChart').getContext('2d');
      if (charts.emocionGeneralChart) charts.emocionGeneralChart.destroy();
      charts.emocionGeneralChart = new Chart(ctxEmociones, {
        type: 'polarArea',
        data: {
          labels: Object.keys(emociones),
          datasets: [{
            data: Object.values(emociones),
            backgroundColor: chartColors.slice(0, Object.keys(emociones).length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Distribuci√≥n de Emociones',
              font: {
                size: 13
              }
            },
            legend: {
              labels: {
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });

      // Gr√°fico de actividades generales
      const actividades = {};
      allData.forEach(row => {
        actividades[row.Actividad] = (actividades[row.Actividad] || 0) + 1;
      });

      const ctxActividades = document.getElementById('actividadGeneralChart').getContext('2d');
      if (charts.actividadGeneralChart) charts.actividadGeneralChart.destroy();
      charts.actividadGeneralChart = new Chart(ctxActividades, {
        type: 'bar',
        data: {
          labels: Object.keys(actividades),
          datasets: [{
            label: 'Reproducciones',
            data: Object.values(actividades),
            backgroundColor: chartColors.slice(0, Object.keys(actividades).length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Actividades m√°s Comunes',
              font: {
                size: 13
              }
            },
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 11
                }
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });

      // Gr√°fico de plataformas generales
      const plataformas = {};
      allData.forEach(row => {
        plataformas[row.Plataforma] = (plataformas[row.Plataforma] || 0) + 1;
      });

      const ctxPlataformas = document.getElementById('plataformaGeneralChart').getContext('2d');
      if (charts.plataformaGeneralChart) charts.plataformaGeneralChart.destroy();
      charts.plataformaGeneralChart = new Chart(ctxPlataformas, {
        type: 'pie',
        data: {
          labels: Object.keys(plataformas),
          datasets: [{
            data: Object.values(plataformas),
            backgroundColor: chartColors.slice(0, Object.keys(plataformas).length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Uso de Plataformas',
              font: {
                size: 13
              }
            },
            legend: {
              labels: {
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }

    function cargarDias() {
      const dias = [...new Set(allData.map(row => row.D√≠a))].sort();
      const select = document.getElementById('daySelect');
      select.innerHTML = '';
      
      dias.forEach(d => {
        const option = document.createElement('option');
        option.value = d;
        option.textContent = d;
        select.appendChild(option);
      });
      
      select.addEventListener('change', () => actualizarGraficosPorDia(select.value));
      if (dias.length > 0) {
        actualizarGraficosPorDia(dias[0]);
      }
    }

    function actualizarGraficosPorDia(dia) {
      const filtrado = allData.filter(row => row.D√≠a === dia);
      
      // Actualizar t√≠tulo del d√≠a seleccionado
      document.getElementById('selectedDayTitle').textContent = `D√≠a seleccionado: ${dia}`;
      
      // Actualizar estad√≠sticas principales
      document.getElementById('totalSongs').textContent = filtrado.length;
      
      // Calcular emoci√≥n principal
      const emociones = {};
      filtrado.forEach(row => {
        emociones[row.Emoci√≥n] = (emociones[row.Emoci√≥n] || 0) + 1;
      });
      const mainEmotion = Object.entries(emociones).sort((a, b) => b[1] - a[1])[0];
      document.getElementById('mainEmotion').textContent = `${mainEmotion[0]} (${mainEmotion[1]})`;
      
      // Calcular lugar principal
      const lugares = {};
      filtrado.forEach(row => {
        lugares[row.Lugar] = (lugares[row.Lugar] || 0) + 1;
      });
      const mainPlace = Object.entries(lugares).sort((a, b) => b[1] - a[1])[0];
      document.getElementById('mainPlace').textContent = `${mainPlace[0]} (${mainPlace[1]})`;
      
      // Calcular plataforma principal
      const plataformas = {};
      filtrado.forEach(row => {
        plataformas[row.Plataforma] = (plataformas[row.Plataforma] || 0) + 1;
      });
      const mainPlatform = Object.entries(plataformas).sort((a, b) => b[1] - a[1])[0];
      document.getElementById('mainPlatform').textContent = `${mainPlatform[0]} (${mainPlatform[1]})`;

      // Gr√°fico de lugares
      crearBarChart('lugarChart', lugares, 'Lugares de Escucha');
      
      // Gr√°fico de plataformas
      crearBarChart('plataformaChart', plataformas, 'Plataformas Usadas');
      
      // Gr√°fico de emociones
      crearPieChart('emocionChart', emociones, 'Emociones del D√≠a');
      
      // Gr√°fico de actividades
      const actividades = {};
      filtrado.forEach(row => {
        actividades[row.Actividad] = (actividades[row.Actividad] || 0) + 1;
      });
      crearBarChart('actividadChart', actividades, 'Actividades Realizadas');
      
      // Gr√°fico de dispositivos
      const dispositivos = {};
      filtrado.forEach(row => {
        dispositivos[row['Dispositivo usado']] = (dispositivos[row['Dispositivo usado']] || 0) + 1;
      });
      crearPieChart('dispositivoChart', dispositivos, 'Dispositivos Usados');
      
      // Gr√°fico de emociones por hora (simulado)
      const horas = {
        '08:00': { 'Energ√©tica': 2, 'Alegre': 1 },
        '12:00': { 'Motivacional': 3, 'Divertida': 2 },
        '18:00': { 'Rom√°ntica': 4, 'Nost√°lgica': 1 }
      };
      crearEmocionesPorHoraChart('horaEmocionChart', horas);
    }

    function crearBarChart(id, data, title) {
      const ctx = document.getElementById(id).getContext('2d');
      
      if (charts[id]) charts[id].destroy();
      
      charts[id] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(data),
          datasets: [{
            label: 'Reproducciones',
            data: Object.values(data),
            backgroundColor: chartColors.slice(0, Object.keys(data).length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: title,
              font: {
                size: 13
              }
            },
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 11
                }
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }

    function crearPieChart(id, data, title) {
      const ctx = document.getElementById(id).getContext('2d');
      
      if (charts[id]) charts[id].destroy();
      
      charts[id] = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(data),
          datasets: [{
            data: Object.values(data),
            backgroundColor: chartColors.slice(0, Object.keys(data).length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: title,
              font: {
                size: 13
              }
            },
            legend: {
              labels: {
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }

    function crearEmocionesPorHoraChart(id, data) {
      const horas = Object.keys(data);
      const emociones = [...new Set(Object.values(data).flatMap(h => Object.keys(h)))];
      
      const datasets = emociones.map(emocion => {
        return {
          label: emocion,
          data: horas.map(hora => data[hora][emocion] || 0),
          backgroundColor: chartColors[emociones.indexOf(emocion) % chartColors.length],
          borderWidth: 1
        };
      });
      
      const ctx = document.getElementById(id).getContext('2d');
      
      if (charts[id]) charts[id].destroy();
      
      charts[id] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: horas,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Emociones por Hora',
              font: {
                size: 13
              }
            },
            legend: {
              labels: {
                font: {
                  size: 11
                }
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              ticks: {
                font: {
                  size: 11
                }
              }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }

    function mostrarTopCanciones() {
      const canciones = {};
      allData.forEach(row => {
        canciones[row.Canci√≥n] = (canciones[row.Canci√≥n] || 0) + 1;
      });
      
      // Ordenar canciones por frecuencia y tomar las top 12
      const topCanciones = Object.entries(canciones)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 12);
      
      const songList = document.getElementById('topSongsList');
      songList.innerHTML = '';
      
      topCanciones.forEach(([cancion, count]) => {
        // Encontrar el primer registro para esta canci√≥n para obtener el artista y emoci√≥n
        const primerRegistro = allData.find(row => row.Canci√≥n === cancion);
        
        const songCard = document.createElement('div');
        songCard.className = 'song-card';
        songCard.innerHTML = `
          <div class="song-title">${cancion}</div>
          <div class="song-artist">${primerRegistro.Artista}</div>
          <div class="song-stats">
            <div class="song-count">${count} rep.</div>
            <div class="song-emoji">${emotionEmojis[primerRegistro.Emoci√≥n] || 'üéµ'}</div>
          </div>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress" style="width: ${(count / topCanciones[0][1]) * 100}%"></div>
            </div>
          </div>
        `;
        songList.appendChild(songCard);
      });
    }

    function mostrarActividadReciente() {
      const tbody = document.getElementById('recentActivity');
      tbody.innerHTML = '';
      
      // Ordenar datos por fecha (m√°s reciente primero)
      const datosOrdenados = [...allData].sort((a, b) => {
        const dateA = new Date(a.D√≠a.split('/').reverse().join('/'));
        const dateB = new Date(b.D√≠a.split('/').reverse().join('/'));
        return dateB - dateA;
      });
      
      // Mostrar solo las 15 m√°s recientes
      datosOrdenados.slice(0, 15).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.D√≠a}</td>
          <td>${row.Canci√≥n}</td>
          <td>${row.Artista}</td>
          <td>${row.Emoci√≥n}</td>
          <td>${row.Actividad}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Inicializar la aplicaci√≥n cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>
